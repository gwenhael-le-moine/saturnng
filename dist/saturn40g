#!/usr/bin/env bash

set -eu

cd "$(dirname "$0")" || exit 1

BINNAME=$(basename "$0")

CONFIG_HOME=${XDG_CONFIG_HOME:-$HOME/.config}

CONFIGDIR=${CONFIGDIR:-$CONFIG_HOME/$BINNAME}
mkdir -p "$CONFIGDIR"

if [ ! -e "$CONFIGDIR"/rom ]; then
    if [ -d ../share/saturn/ROMs/ ]; then
        cp -r ../share/saturn/ROMs/ "$CONFIGDIR"/ROMs
    elif [ -d ./ROMs/ ]; then
        cp -r ./ROMs/ "$CONFIGDIR"/ROMs
    fi
    if [ ! -d "$CONFIGDIR"/ROMs ]; then
        echo "Error: No ROMs/ dir found"
        exit 1
    fi

    echo "The next step will download a ROM from https://hpcalc.org where \"HP graciously began allowing this to be downloaded in mid-2000.\""
    echo "You can hit Ctrl-C now if you do not wish to download them."
    read -r

    make -C "$CONFIGDIR"/ROMs rom.39g
    cp "$CONFIGDIR"/ROMs/rom.39g "$CONFIGDIR"/rom
fi

RESET=
if [ ! -e "$CONFIGDIR"/ram ]; then
    RESET=--reset
fi

if [ ! -e "$CONFIGDIR"/config.lua ]; then
    ./saturn --40g --state-dir "$CONFIGDIR" --print-config > "$CONFIGDIR"/config.lua
fi

./saturn --40g --state-dir "$CONFIGDIR" $RESET "$@"
